- name: check if cargo is installed
  become: false
  ansible.builtin.shell: command -v cargo
  register: cargo_exists
  ignore_errors: true
  tags: rust

- name: Download installer
  become: false
  when: cargo_exists is failed
  ansible.builtin.get_url:
    url: https://sh.rustup.rs
    dest: /tmp/sh.rustup.rs
    mode: '0755'
    force: yes
  tags: rust

- name: install rust/cargo
  become: false
  when: cargo_exists is failed
  ansible.builtin.shell: /tmp/sh.rustup.rs -y
  tags: rust

- name: update rust/cargo
  become: false
  ansible.builtin.shell: |
    $HOME/.cargo/bin/rustup update stable
    $HOME/.cargo/bin/rustup default stable
  tags: rust

- name: Source environment for cargo
  become: false
  lineinfile:
    dest: "{{ cfg_path }}"
    line: '[ -f ~/.cargo/env ] && source "$HOME/.cargo/env"'
    regexp: '^[ -f ~/.cargo/env ]'
    state: present
    create: true
  loop:
    - ~/.bash_ansible
    - ~/.zsh_ansible
  loop_control:
    loop_var: cfg_path
